flowchart LR
    A[Início: on_image] --> B{view_rgb é NULL?}
    B -->|Sim| C[Retorna]
    B -->|Não| D[Armazena dimensões da imagem]
    D --> E[convert_view_to_view_template]
    E --> F[Divide imagem em blocos]
    F --> G[Calcula médias dos blocos]
    G --> H{Normalização global?}
    H -->|Sim| I[Aplica normalização global]
    H -->|Não| J{Normalização por região?}
    I --> J
    J -->|Sim| K[Aplica normalização local]
    J -->|Não| L[Armazena template atual]
    K --> L
    L --> M[compare]
    M --> N[Compara com templates existentes]
    N --> O{Erro <= Threshold?}
    O -->|Sim| P[Reusa template existente]
    O -->|Não| Q[Cria novo template]
    P --> R[Atualiza current_vt]
    Q --> R
    R --> S[Saída: ID do template]