%% Diagrama de Funcionamento das PoseCells
graph TD
    %% ========== ENTRADAS ==========
     A[Odometria] -->|vtrans, vrot, dt| B["on_odo()"]
    C[Template Visual] -->|vt_id, vt_rad| D["on_view_template()"]

    %% ========== PROCESSAMENTO PRINCIPAL ==========
    B --> E[Processamento Odométrico]
    D --> F[Correção Visual]
    
    E --> G[Excite]
    E --> H[Inhibit]
    E --> I[Global Inhibit]
    E --> J[Normalise]
    E --> K[Path Integration]
    E --> L["find_best()"]

    F --> M[Injeção de Energia]
    F --> N[Atualização VT]
    
    %% ========== SAÍDAS E ESTADOS ==========
    L --> O[best_x, best_y, best_th]
    O --> P["get_action()"]
    
    P -->|CREATE_NODE| Q[Novo Nó ExperienceMap]
    P -->|CREATE_EDGE| R[Nova Aresta ExperienceMap]
    P -->|SET_NODE| S[Atualiza Nó Atual]

    %% ========== SUBSISTEMAS ==========
    subgraph "Memória de PoseCells (3D)"
        T["Matriz posecells[x][y][θ]"]
        U[Kernels Excite/Inhibit]
        V[Wrap-around]
    end

    subgraph "Templates Visuais"
        W[VT1<br>pc_x, pc_y, pc_th]
        X[VT2<br>...]
    end

    subgraph "Experiências"
        Y[EXP1<br>assoc_vt, x_pc, y_pc, th_pc]
        Z[EXP2<br>...]
    end

     %% ========== FLUXO DE DADOS ==========
    G --> T
    H --> T
    I --> T
    J --> T
    K --> T
    M --> T
    T --> L
    W --> F
    Y --> P